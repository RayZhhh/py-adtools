# Sandbox Execution

When working with code generated by Large Language Models (LLMs), security is a primary concern. `adtools.sandbox` provides a robust sandboxing environment to safely execute untrusted Python code in an isolated process.

## Core Features

- **Process Isolation**: Each execution runs in a separate child process, preventing malicious code from affecting the main program.
- **Timeout Control**: Set a timeout for each execution to effectively handle infinite loops or long-running operations.
- **Resource Protection**: The isolated execution environment protects critical resources like the file system and network.
- **Output Redirection**: Redirect all standard output (`stdout`) and standard error (`stderr`) from the child process to `/dev/null` to keep the main console clean.

## Sandbox Executors

`adtools` provides two sandbox implementations:

1.  **`SandboxExecutor`**:
    *   Based on the standard `multiprocessing` library.
    *   Uses shared memory (`shared_memory`) to efficiently pass large return objects, avoiding the overhead of `pickle` serialization.
    *   Ideal for high-performance, secure evaluation in a single-machine environment.

2.  **`SandboxExecutorRay`**:
    *   Based on the `Ray` framework for distributed execution.
    *   Perfect for scenarios requiring large-scale evaluation on a cluster or stronger isolation.
    *   Leverages Ray's capabilities for zero-copy returns of large objects.

## `SandboxExecutor` Usage Example

You can wrap an instance of any class in `SandboxExecutor` to execute its methods securely in a sandbox.

```python
import time
from typing import Any
from adtools.sandbox import SandboxExecutor

# This is a worker class containing the evaluation logic
class SortAlgorithmEvaluator:
    def evaluate_program(self, program: str) -> Any | None:
        g = {}
        exec(program, g)
        sort_algo = g.get("merge_sort")
        if not sort_algo: return None
        
        input_data = [10, 2, 4, 76, 19, 29, 3, 5, 1]
        start = time.time()
        res = sort_algo(input_data)
        duration = time.time() - start
        
        return duration if res == sorted(input_data) else None

# Code generated by an LLM
code_generated_by_llm = """
def merge_sort(arr):
    # ... (full implementation of the sorting algorithm)
    if len(arr) <= 1: return arr
    mid = len(arr) // 2
    left = merge_sort(arr[:mid])
    right = merge_sort(arr[mid:])
    def merge(left, right):
        result = []
        i = j = 0
        while i < len(left) and j < len(right):
            if left[i] < right[j]:
                result.append(left[i]); i += 1
            else:
                result.append(right[j]); j += 1
        result.extend(left[i:])
        result.extend(right[j:])
        return result
    return merge(left, right)
"""

# Potentially harmful code (infinite loop)
harmful_code = "def merge_sort(arr):\n    while True: pass"

if __name__ == "__main__":
    # Initialize the sandbox executor with the evaluator worker instance
    sandbox = SandboxExecutor(SortAlgorithmEvaluator())

    # 1. Securely execute the correct code
    results = sandbox.secure_execute(
        "evaluate_program",
        method_args=(code_generated_by_llm,),
        timeout_seconds=10
    )
    print(f"Score for correct code: {results['result']}")
    print(f"Execution time: {results['evaluate_time']:.4f}s")

    # 2. Securely execute the harmful code
    results = sandbox.secure_execute(
        "evaluate_program",
        method_args=(harmful_code,),
        timeout_seconds=5  # Set a 5-second timeout
    )
    
    # Due to timeout, the result will be None and an error message will be recorded
    print(f"\nScore for harmful code: {results['result']}")
    print(f"Error Message: {results['error_msg']}")
```

The `secure_execute` method returns an `ExecutionResults` dictionary containing the following fields:
- `result`: The return value of the method. `None` in case of a timeout or error.
- `evaluate_time`: The time taken for the evaluation.
- `error_msg`: Contains an error message if an error (like a timeout) occurred.
